<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Iniciar sesión</title>

    <script>
      // ✅ Supabase (DEBE ser EXACTO)
      window.SUPABASE_URL = "https://zvuzrpvsnkhnlfqtscrl.supabase.co";
      window.SUPABASE_ANON_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp2dXpycHZzbmtobmxmcXRzY3JsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk0MTIyNjMsImV4cCI6MjA3NDk4ODI2M30.jHsdk4byoUkmifOYch8soUoR5h6DInVbNbJcEQEfBng";
    </script>

    <!-- ✅ Forzar SIEMPRE el tema oscuro -->
    <script>
      (function () {
        const root = document.documentElement;
        const forceDark = () => {
          if (!root.classList.contains("dark")) root.classList.add("dark");
        };
        forceDark();
        const obs = new MutationObserver(forceDark);
        obs.observe(root, { attributes: true, attributeFilter: ["class"] });
      })();
    </script>

    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script id="tailwind-config">
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              primary: "#ec1313",
              "background-dark": "#221010",
              accent: "#FFCC00",
            },
            fontFamily: {
              display: ["Plus Jakarta Sans", "sans-serif"],
            },
          },
        },
      };
    </script>

    <!-- ✅ Cloudflare Turnstile -->
    <script
      src="https://challenges.cloudflare.com/turnstile/v0/api.js"
      async
      defer
    ></script>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous" />
    <link
      href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;700;800&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="/styles.css" />
  </head>

  <body class="bg-background-dark text-white font-display min-h-screen flex flex-col">
    <!-- Loader -->
    <div id="global-loader" class="hidden">
      <div class="loader-box">
        <div class="loader-spinner"></div>
        <p id="loader-text" class="text-sm text-white/80">Cargando…</p>
      </div>
    </div>

    <div class="flex-1 max-w-md mx-auto w-full px-4 py-6 flex flex-col">
      <!-- Back button -->
      <div class="flex items-center justify-between">
        <button
          id="back-btn"
          type="button"
          class="inline-flex items-center gap-2 rounded-full px-3 py-2 bg-white/5 hover:bg-white/10 border border-white/10 text-white/90 font-semibold transition"
          aria-label="Volver"
          title="Volver"
        >
          <!-- Arrow left (SVG) -->
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path
              d="M15 18l-6-6 6-6"
              stroke="currentColor"
              stroke-width="2.5"
              stroke-linecap="round"
              stroke-linejoin="round"
            />
          </svg>
          <span class="text-sm">Volver</span>
        </button>

        <!-- Placeholder right side (optional) -->
        <div class="w-[76px]"></div>
      </div>

      <div class="pt-4 pb-4">
        <h1 class="text-white text-[32px] font-bold leading-tight tracking-tight">
          Iniciar sesión
        </h1>
        <p class="text-gray-400 text-base leading-normal pt-1">
          Ingresa para ordenar tus hamburguesas favoritas.
        </p>
      </div>

      <!-- Vista normal (login) -->
      <div id="login-view">
        <form id="login-form" class="flex flex-col gap-y-3">
          <label class="flex flex-col w-full">
            <p class="text-white text-base font-medium pb-2">Correo</p>
            <input
              class="form-input flex w-full rounded-xl text-white border border-gray-700/80 bg-black/30 h-14 px-4 text-base"
              placeholder="correo@ejemplo.com"
              type="email"
              name="correo"
              required
            />
          </label>

          <label class="flex flex-col w-full">
            <p class="text-white text-base font-medium pb-2">Contraseña</p>
            <input
              class="form-input flex w-full rounded-xl text-white border border-gray-700/80 bg-black/30 h-14 px-4 text-base"
              placeholder="Tu contraseña"
              type="password"
              name="contrasena"
              required
            />
          </label>

          <!-- Turnstile -->
          <div class="mt-2">
            <div
              class="cf-turnstile"
              data-sitekey="0x4AAAAAACJnxeR3E7NemaeK"
              data-theme="dark"
              data-size="normal"
            ></div>
            <p class="text-xs text-white/50 mt-2">Verificación para evitar bots.</p>
          </div>

          <p id="login-error" class="text-red-500 text-sm font-medium mt-1 hidden"></p>

          <div class="flex justify-end mt-1">
            <a href="/recover" class="text-sm text-accent hover:underline font-medium">
              ¿Olvidaste tu contraseña?
            </a>
          </div>

          <!-- ✅ Iniciar sesión primero -->
          <button
            type="submit"
            class="mt-3 flex items-center justify-center h-14 w-full rounded-xl bg-primary px-4 text-base font-bold text-white shadow-sm hover:bg-primary/90 transition"
          >
            Iniciar sesión
          </button>

          <!-- Divider -->
          <div class="flex items-center gap-3 mt-2">
            <div class="h-px flex-1 bg-white/10"></div>
            <span class="text-xs text-white/45 font-semibold uppercase tracking-[0.2em]">
              o
            </span>
            <div class="h-px flex-1 bg-white/10"></div>
          </div>

          <!-- ✅ Google button más profesional con logo -->
          <button
            id="google-login"
            type="button"
            class="mt-2 flex items-center justify-center gap-3 h-14 w-full rounded-xl bg-white text-[#1f1f1f] font-extrabold shadow-sm hover:shadow-md transition border border-black/10"
          >
            <!-- Google "G" (SVG inline, multicolor) -->
            <svg width="20" height="20" viewBox="0 0 48 48" aria-hidden="true">
              <path
                fill="#EA4335"
                d="M24 9.5c3.54 0 6.72 1.22 9.24 3.62l6.9-6.9C35.98 2.39 30.44 0 24 0 14.62 0 6.51 5.38 2.56 13.22l8.02 6.23C12.5 13.32 17.82 9.5 24 9.5z"
              />
              <path
                fill="#4285F4"
                d="M46.5 24.5c0-1.64-.15-3.22-.43-4.75H24v9h12.66c-.55 2.98-2.2 5.5-4.66 7.2l7.2 5.58c4.2-3.87 6.6-9.57 6.6-17.03z"
              />
              <path
                fill="#FBBC05"
                d="M10.58 28.45c-.5-1.5-.78-3.1-.78-4.75s.28-3.25.78-4.75l-8.02-6.23C.92 16.2 0 20.03 0 23.7c0 3.67.92 7.5 2.56 10.98l8.02-6.23z"
              />
              <path
                fill="#34A853"
                d="M24 48c6.44 0 11.98-2.12 15.98-5.77l-7.2-5.58c-2 1.35-4.57 2.15-8.78 2.15-6.18 0-11.5-3.82-13.42-9.15l-8.02 6.23C6.51 42.62 14.62 48 24 48z"
              />
              <path fill="none" d="M0 0h48v48H0z" />
            </svg>

            <span>Continuar con Google</span>
          </button>
        </form>

        <div class="mt-4 text-center text-sm text-gray-400">
          ¿No tienes cuenta?
          <a href="/register" class="font-bold text-accent hover:underline">Regístrate</a>
        </div>
      </div>

      <!-- Vista: crear contraseña luego de Google -->
      <div id="set-password-view" class="hidden mt-6 border border-gray-700/60 bg-black/30 rounded-2xl p-4">
        <h2 class="font-extrabold text-xl">Crea tu contraseña</h2>
        <p class="text-white/60 text-sm mt-1">
          Te logueaste con Google. Ahora define una contraseña para poder iniciar también manualmente.
        </p>

        <div class="mt-4 flex flex-col gap-3">
          <label class="flex flex-col">
            <span class="text-sm text-white/80 mb-1">Nueva contraseña</span>
            <input
              id="new-pass"
              type="password"
              class="form-input w-full rounded-xl text-white border border-gray-700/80 bg-black/30 h-12 px-4"
              placeholder="Mínimo 8 caracteres"
            />
          </label>

          <label class="flex flex-col">
            <span class="text-sm text-white/80 mb-1">Confirmar contraseña</span>
            <input
              id="new-pass-2"
              type="password"
              class="form-input w-full rounded-xl text-white border border-gray-700/80 bg-black/30 h-12 px-4"
              placeholder="Repite la contraseña"
            />
          </label>

          <p id="setpass-error" class="text-red-500 text-sm font-medium hidden"></p>

          <button
            id="setpass-btn"
            type="button"
            class="mt-2 flex items-center justify-center h-12 w-full rounded-xl bg-white text-black font-extrabold hover:opacity-90"
          >
            Guardar contraseña
          </button>

          <button
            id="skip-btn"
            type="button"
            class="text-sm text-white/60 underline mt-1"
          >
            Lo haré después
          </button>
        </div>
      </div>
    </div>

    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Crear cliente Supabase (window.sb) -->
    <script>
      (function () {
        if (!window.supabase || !window.supabase.createClient) {
          console.error("[login] supabase-js no cargó");
          return;
        }
        if (!window.SUPABASE_URL || !window.SUPABASE_ANON_KEY) {
          console.error("[login] faltan SUPABASE_URL / SUPABASE_ANON_KEY");
          return;
        }

        window.sb = window.supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY, {
          auth: {
            // OAuth SPA usa PKCE
            flowType: "pkce",
            persistSession: true,
            autoRefreshToken: true,
            detectSessionInUrl: true,
          },
        });
      })();
    </script>

    <!-- Back button logic -->
    <script>
      (function () {
        const btn = document.getElementById("back-btn");
        if (!btn) return;

        btn.addEventListener("click", () => {
          try {
            if (window.history.length > 1) window.history.back();
            else window.location.href = "/";
          } catch {
            window.location.href = "/";
          }
        });
      })();
    </script>

    <!-- Lógica de login -->
    <script src="/auth.js"></script>
  </body>
</html>
