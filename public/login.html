<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Iniciar sesión</title>

    <script>
      // ✅ Supabase (DEBE ser EXACTO)
      window.SUPABASE_URL = "https://zvuzrpvsnkhnlfqtscrl.supabase.co";
      window.SUPABASE_ANON_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp2dXpycHZzbmtobmxmcXRzY3JsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk0MTIyNjMsImV4cCI6MjA3NDk4ODI2M30.jHsdk4byoUkmifOYch8soUoR5h6DInVbNbJcEQEfBng";
    </script>

    <!-- ✅ Forzar SIEMPRE el tema oscuro -->
    <script>
      (function () {
        const root = document.documentElement;
        const forceDark = () => {
          if (!root.classList.contains("dark")) root.classList.add("dark");
        };
        forceDark();
        const obs = new MutationObserver(forceDark);
        obs.observe(root, { attributes: true, attributeFilter: ["class"] });
      })();
    </script>

    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script id="tailwind-config">
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              primary: "#ec1313",
              "background-dark": "#221010",
              accent: "#FFCC00",
            },
            fontFamily: {
              display: ["Plus Jakarta Sans", "sans-serif"],
            },
          },
        },
      };
    </script>

    <!-- ✅ Cloudflare Turnstile -->
    <script
      src="https://challenges.cloudflare.com/turnstile/v0/api.js"
      async
      defer
    ></script>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous" />
    <link
      href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;700;800&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="/styles.css" />
  </head>

  <body class="bg-background-dark text-white font-display min-h-screen flex flex-col">
    <!-- Loader -->
    <div id="global-loader" class="hidden">
      <div class="loader-box">
        <div class="loader-spinner"></div>
        <p id="loader-text" class="text-sm text-white/80">Cargando…</p>
      </div>
    </div>

    <div class="flex-1 max-w-md mx-auto w-full px-4 py-6 flex flex-col">
      <div class="pt-2 pb-4">
        <h1 class="text-white text-[32px] font-bold leading-tight tracking-tight">
          Iniciar sesión
        </h1>
        <p class="text-gray-400 text-base leading-normal pt-1">
          Ingresa para ordenar tus hamburguesas favoritas.
        </p>
      </div>

      <!-- Vista normal (login) -->
      <div id="login-view">
        <form id="login-form" class="flex flex-col gap-y-3">
          <label class="flex flex-col w-full">
            <p class="text-white text-base font-medium pb-2">Correo</p>
            <input
              class="form-input flex w-full rounded-xl text-white border border-gray-700/80 bg-black/30 h-14 px-4 text-base"
              placeholder="correo@ejemplo.com"
              type="email"
              name="correo"
              required
            />
          </label>

          <label class="flex flex-col w-full">
            <p class="text-white text-base font-medium pb-2">Contraseña</p>
            <input
              class="form-input flex w-full rounded-xl text-white border border-gray-700/80 bg-black/30 h-14 px-4 text-base"
              placeholder="Tu contraseña"
              type="password"
              name="contrasena"
              required
            />
          </label>

          <!-- Turnstile -->
          <div class="mt-2">
            <div
              class="cf-turnstile"
              data-sitekey="0x4AAAAAACJnxeR3E7NemaeK"
              data-theme="dark"
              data-size="normal"
            ></div>
            <p class="text-xs text-white/50 mt-2">Verificación para evitar bots.</p>
          </div>

          <p id="login-error" class="text-red-500 text-sm font-medium mt-1 hidden"></p>

          <div class="flex justify-end mt-1">
            <a href="/recover" class="text-sm text-accent hover:underline font-medium">
              ¿Olvidaste tu contraseña?
            </a>
          </div>

          <button
            id="google-login"
            type="button"
            class="mt-2 flex items-center justify-center h-14 w-full rounded-xl bg-white text-black font-bold shadow-sm hover:opacity-90 transition"
          >
            Continuar con Google
          </button>

          <button
            type="submit"
            class="mt-3 flex items-center justify-center h-14 w-full rounded-xl bg-primary px-4 text-base font-bold text-white shadow-sm hover:bg-primary/90"
          >
            Iniciar sesión
          </button>
        </form>

        <div class="mt-4 text-center text-sm text-gray-400">
          ¿No tienes cuenta?
          <a href="/register" class="font-bold text-accent hover:underline">Regístrate</a>
        </div>
      </div>

      <!-- Vista: crear contraseña luego de Google -->
      <div id="set-password-view" class="hidden mt-6 border border-gray-700/60 bg-black/30 rounded-2xl p-4">
        <h2 class="font-extrabold text-xl">Crea tu contraseña</h2>
        <p class="text-white/60 text-sm mt-1">
          Te logueaste con Google. Ahora define una contraseña para poder iniciar también manualmente.
        </p>

        <div class="mt-4 flex flex-col gap-3">
          <label class="flex flex-col">
            <span class="text-sm text-white/80 mb-1">Nueva contraseña</span>
            <input
              id="new-pass"
              type="password"
              class="form-input w-full rounded-xl text-white border border-gray-700/80 bg-black/30 h-12 px-4"
              placeholder="Mínimo 8 caracteres"
            />
          </label>

          <label class="flex flex-col">
            <span class="text-sm text-white/80 mb-1">Confirmar contraseña</span>
            <input
              id="new-pass-2"
              type="password"
              class="form-input w-full rounded-xl text-white border border-gray-700/80 bg-black/30 h-12 px-4"
              placeholder="Repite la contraseña"
            />
          </label>

          <p id="setpass-error" class="text-red-500 text-sm font-medium hidden"></p>

          <button
            id="setpass-btn"
            type="button"
            class="mt-2 flex items-center justify-center h-12 w-full rounded-xl bg-white text-black font-extrabold hover:opacity-90"
          >
            Guardar contraseña
          </button>

          <button
            id="skip-btn"
            type="button"
            class="text-sm text-white/60 underline mt-1"
          >
            Lo haré después
          </button>
        </div>
      </div>
    </div>

    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Crear cliente Supabase (window.sb) -->
    <script>
      (function () {
        if (!window.supabase || !window.supabase.createClient) {
          console.error("[login] supabase-js no cargó");
          return;
        }
        if (!window.SUPABASE_URL || !window.SUPABASE_ANON_KEY) {
          console.error("[login] faltan SUPABASE_URL / SUPABASE_ANON_KEY");
          return;
        }

        window.sb = window.supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY, {
          auth: {
            // OAuth SPA usa PKCE
            flowType: "pkce",
            persistSession: true,
            autoRefreshToken: true,
            detectSessionInUrl: true,
          },
        });
      })();
    </script>

    <!-- Lógica de login -->
    <script src="/auth.js"></script>
  </body>
</html>
